{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///home/user/veterinariamagali/src/app/actions/turnosActions.js"],"sourcesContent":["\n'use server';\n\nimport { revalidatePath } from 'next/cache';\nimport admin from '@/lib/firebaseAdmin';\nimport { cookies } from 'next/headers';\nimport { getUserIdFromSession } from '@/lib/firebaseAdmin';\n\n// --- Lógica para Turnos de Peluquería ---\n\nconst MAX_PERROS_GRANDES_POR_DIA = 2;\nconst MAX_TURNOS_POR_TURNO_PELUQUERIA = 8;\n\nexport async function solicitarTurnoPeluqueria(turnoData) {\n    const { clienteId, mascotaId, fecha, turno, servicios, transporte } = turnoData;\n\n    if (!clienteId || !mascotaId || !fecha || !turno) {\n        return { success: false, error: 'Faltan datos esenciales para solicitar el turno.' };\n    }\n\n    const firestore = admin.firestore();\n\n    try {\n        const mascotaRef = firestore.collection('users').doc(clienteId).collection('mascotas').doc(mascotaId);\n        const mascotaSnap = await mascotaRef.get();\n\n        if (!mascotaSnap.exists) {\n            return { success: false, error: 'La mascota seleccionada no existe.' };\n        }\n        const tamañoMascota = mascotaSnap.data().tamaño;\n\n        const resultado = await firestore.runTransaction(async (transaction) => {\n            const turnosRef = firestore.collection('turnos');\n\n            if (tamañoMascota === 'grande') {\n                const qGrandes = turnosRef\n                    .where('fecha', '==', fecha)\n                    .where('tipo', '==', 'peluqueria')\n                    .where('tamañoMascota', '==', 'grande')\n                    .where('estado', 'in', ['pendiente', 'confirmado']);\n                \n                const snapGrandes = await transaction.get(qGrandes);\n                if (snapGrandes.docs.length >= MAX_PERROS_GRANDES_POR_DIA) {\n                    throw new Error('El cupo para perros grandes en esta fecha ya está completo.');\n                }\n            }\n\n            const qTurno = turnosRef\n                .where('fecha', '==', fecha)\n                .where('turno', '==', turno)\n                .where('tipo', '==', 'peluqueria')\n                .where('estado', 'in', ['pendiente', 'confirmado']);\n\n            const snapTurno = await transaction.get(qTurno);\n            if (snapTurno.docs.length >= MAX_TURNOS_POR_TURNO_PELUQUERIA) {\n                throw new Error(`El turno de la ${turno} para esta fecha ya está completo.`);\n            }\n\n            const nuevoTurnoRef = firestore.collection('turnos').doc();\n            transaction.set(nuevoTurnoRef, {\n                ...turnoData,\n                tamañoMascota,\n                estado: 'pendiente',\n                createdAt: new Date().toISOString(),\n            });\n\n            return { success: true, turnoId: nuevoTurnoRef.id };\n        });\n\n        revalidatePath('/admin/turnos');\n        revalidatePath('/mis-turnos');\n        return resultado;\n\n    } catch (error) {\n        console.error('Error en la transacción de solicitud de turno de peluquería:', error);\n        return { success: false, error: error.message };\n    }\n}\n\n\n// --- Lógica para Turnos de Consulta ---\n\nexport async function solicitarTurnoConsulta(turnoData) {\n    const { clienteId, mascotaId, fecha, turno, motivo } = turnoData;\n\n    if (!clienteId || !mascotaId || !fecha || !turno || !motivo) {\n        return { success: false, error: 'Faltan datos esenciales para solicitar el turno.' };\n    }\n\n    const firestore = admin.firestore();\n\n    try {\n        const nuevoTurnoRef = firestore.collection('turnos').doc();\n        \n        await nuevoTurnoRef.set({\n            ...turnoData,\n            tipo: 'consulta',\n            estado: 'pendiente',\n            createdAt: new Date().toISOString(),\n        });\n\n        revalidatePath('/admin/turnos');\n        revalidatePath('/mis-turnos');\n\n        return { success: true, turnoId: nuevoTurnoRef.id };\n\n    } catch (error) {\n        console.error('Error al solicitar el turno de consulta:', error);\n        return { success: false, error: 'Ocurrió un error inesperado al guardar la solicitud.' };\n    }\n}\n\n\n// --- LÓGICA DE CANCELACIÓN DE TURNO (PARA USUARIOS) ---\n\nexport async function cancelarTurnoUsuario(turnoId) {\n    const sessionCookie = cookies().get('__session')?.value || '';\n    const userId = await getUserIdFromSession(sessionCookie);\n\n    if (!userId) {\n        return { success: false, error: 'No estás autenticado.' };\n    }\n\n    if (!turnoId) {\n        return { success: false, error: 'No se proporcionó un ID de turno.' };\n    }\n\n    const firestore = admin.firestore();\n    const turnoRef = firestore.collection('turnos').doc(turnoId);\n\n    try {\n        const turnoSnap = await turnoRef.get();\n\n        if (!turnoSnap.exists) {\n            return { success: false, error: 'El turno no existe.' };\n        }\n\n        const turnoData = turnoSnap.data();\n\n        // Verificación de propiedad\n        if (turnoData.userId !== userId) {\n            return { success: false, error: 'No tienes permiso para cancelar este turno.' };\n        }\n\n        // Verificar que el turno no esté ya cancelado o completado\n        if ([ 'cancelado', 'completado'].includes(turnoData.estado)) {\n            return { success: false, error: 'Este turno ya no se puede cancelar.' };\n        }\n\n        // Verificar que la fecha del turno no haya pasado\n        const hoy = new Date();\n        hoy.setHours(0, 0, 0, 0);\n        const fechaTurno = new Date(turnoData.fecha + 'T12:00:00'); // Asegurar que la comparación de fechas sea correcta\n\n        if (fechaTurno < hoy) {\n            return { success: false, error: 'No se puede cancelar un turno que ya ha pasado.' };\n        }\n\n        // Actualizar el estado del turno\n        await turnoRef.update({\n            estado: 'cancelado',\n            canceladoAt: new Date().toISOString(),\n            canceladoPor: 'usuario'\n        });\n\n        // Revalidar cachés para que las vistas se actualicen\n        revalidatePath('/mis-turnos');\n        revalidatePath('/admin/turnos');\n\n        return { success: true };\n\n    } catch (error) {\n        console.error('Error al cancelar el turno:', error);\n        return { success: false, error: 'Ocurrió un error inesperado al intentar cancelar el turno.' };\n    }\n}\n"],"names":[],"mappings":";;;;;;;IAasB,2BAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA","debugId":null}},
    {"offset": {"line": 19, "column": 0}, "map": {"version":3,"sources":["file:///home/user/veterinariamagali/src/app/components/FormularioTurnoPeluqueria.jsx"],"sourcesContent":["\n'use client';\n\nimport { useState, useEffect } from 'react';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { DayPicker } from 'react-day-picker';\nimport 'react-day-picker/dist/style.css';\nimport { es } from 'date-fns/locale';\nimport { solicitarTurnoPeluqueria } from '@/app/actions/turnosActions';\n\n// El componente ahora recibe las propiedades de disponibilidad\nexport default function FormularioTurnoPeluqueria({ \n    mascotas, \n    ocupacion, \n    disabledDays: initialDisabledDays, \n    maxTurnosManana,\n    maxTurnosTarde\n}) {\n    const { user } = useAuth();\n    const [mascota, setMascota] = useState('');\n    const [fecha, setFecha] = useState(null);\n    const [turno, setTurno] = useState(''); // 'manana' o 'tarde'\n    const [servicios, setServicios] = useState({ cepillado: false, rapado: false, corteTijera: false });\n    const [transporte, setTransporte] = useState(false);\n    const [error, setError] = useState('');\n    const [success, setSuccess] = useState('');\n    const [loading, setLoading] = useState(false);\n\n    // Estados para la lógica de disponibilidad\n    const [isMananaDisabled, setMananaDisabled] = useState(false);\n    const [isTardeDisabled, setTardeDisabled] = useState(false);\n\n    // Convertimos los días deshabilitados que vienen como string a objetos Date\n    const disabledDays = initialDisabledDays.map(day => {\n        if (typeof day === 'string') return new Date(day + 'T12:00:00');\n        return day;\n    });\n\n    // Efecto que se ejecuta cada vez que el usuario elige una fecha\n    useEffect(() => {\n        if (fecha) {\n            const fechaString = fecha.toISOString().split('T')[0];\n            const ocupacionDia = ocupacion[fechaString];\n\n            // Verificamos si la mañana está llena\n            setMananaDisabled(ocupacionDia && ocupacionDia.manana >= maxTurnosManana);\n\n            // Verificamos si la tarde está llena\n            setTardeDisabled(ocupacionDia && ocupacionDia.tarde >= maxTurnosTarde);\n\n            // Si el turno que estaba seleccionado ahora está deshabilitado, lo reseteamos\n            if (turno === 'manana' && isMananaDisabled) setTurno('');\n            if (turno === 'tarde' && isTardeDisabled) setTurno('');\n        }\n    }, [fecha, ocupacion, maxTurnosManana, maxTurnosTarde, turno, isMananaDisabled, isTardeDisabled]);\n\n    const handleServicioChange = (event) => {\n        const { name, checked } = event.target;\n        setServicios(prev => ({ ...prev, [name]: checked }));\n    };\n\n    const handleSubmit = async (event) => {\n        event.preventDefault();\n        if (!user || !mascota || !fecha || !turno) {\n            setError('Por favor, completa todos los campos requeridos.');\n            return;\n        }\n        \n        setLoading(true);\n        setError('');\n        setSuccess('');\n\n        const servicesArray = Object.keys(servicios).filter(key => servicios[key]);\n        const selectedMascota = mascotas.find(m => m.id === mascota);\n\n        const turnoData = {\n            clienteId: user.uid,\n            mascotaId: mascota,\n            tamañoMascota: selectedMascota?.tamaño || 'desconocido', // CORRECCIÓN: Añadimos el tamaño\n            fecha: fecha.toISOString().split('T')[0],\n            turno,\n            servicios: servicesArray,\n            transporte,\n            tipo: 'peluqueria',\n        };\n\n        try {\n            const result = await solicitarTurnoPeluqueria(turnoData);\n            if (result.success) {\n                setSuccess('¡Solicitud de turno enviada con éxito! Nos pondremos en contacto para confirmar.');\n                setMascota(''); setFecha(null); setTurno(''); setTransporte(false);\n                setServicios({ cepillado: false, rapado: false, corteTijera: false });\n            } else {\n                setError(result.error || 'No se pudo procesar la solicitud.');\n            }\n        } catch (err) {\n            setError('Ocurrió un error inesperado.');\n        } finally {\n            setLoading(false);\n        }\n    };\n\n    return (\n        <form onSubmit={handleSubmit} className=\"max-w-xl mx-auto bg-white p-8 rounded-2xl shadow-xl space-y-6\">\n            <h2 className=\"text-2xl font-bold text-center text-gray-800\">Solicitar Turno de Peluquería</h2>\n\n            {error && <p className=\"text-sm text-red-600 bg-red-100 p-3 rounded-md text-center font-semibold\">{error}</p>}\n            {success && <p className=\"text-sm text-green-700 bg-green-100 p-3 rounded-md text-center font-semibold\">{success}</p>}\n\n            {/* --- SECCIONES DEL FORMULARIO (ahora con lógica de deshabilitación) -- */}\n            <div>\n                <label htmlFor=\"mascota\" className=\"block text-sm font-medium text-gray-700 mb-1\">Elige tu mascota</label>\n                <select id=\"mascota\" value={mascota} onChange={(e) => setMascota(e.target.value)} required className=\"w-full input\">\n                    <option value=\"\">Selecciona una mascota</option>\n                    {mascotas.map(m => <option key={m.id} value={m.id}>{m.nombre} ({m.tamaño})</option>)}\n                </select>\n            </div>\n\n            <div className=\"flex flex-col items-center\">\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">1. Selecciona el día</label>\n                <DayPicker mode=\"single\" selected={fecha} onSelect={setFecha} locale={es} disabled={disabledDays} className=\"bg-violet-50 p-4 rounded-lg\" modifiersClassNames={{ selected: 'bg-violet-600 text-white', today: 'text-violet-700 font-bold' }}/>\n            </div>\n            \n            <div>\n                 <label className=\"block text-sm font-medium text-gray-700 mb-2\">2. Selecciona el turno disponible</label>\n                 <div className=\"grid grid-cols-2 gap-4\">\n                    <button type=\"button\" onClick={() => setTurno('manana')} \n                        disabled={isMananaDisabled || !fecha} \n                        className={`py-3 rounded-lg text-sm font-semibold transition-all duration-200 \n                            ${turno === 'manana' ? 'bg-violet-600 text-white shadow-lg ring-2 ring-violet-400' : 'bg-gray-200 text-gray-700'} \n                            ${isMananaDisabled || !fecha ? 'bg-gray-100 text-gray-400 cursor-not-allowed opacity-70' : 'hover:bg-violet-500 hover:text-white'}`}>\n                        Turno Mañana (8hs - 12hs)\n                    </button>\n                    <button type=\"button\" onClick={() => setTurno('tarde')} \n                        disabled={isTardeDisabled || !fecha} \n                        className={`py-3 rounded-lg text-sm font-semibold transition-all duration-200 \n                            ${turno === 'tarde' ? 'bg-violet-600 text-white shadow-lg ring-2 ring-violet-400' : 'bg-gray-200 text-gray-700'} \n                            ${isTardeDisabled || !fecha ? 'bg-gray-100 text-gray-400 cursor-not-allowed opacity-70' : 'hover:bg-violet-500 hover:text-white'}`}>\n                        Turno Tarde (13hs - 17hs)\n                    </button>\n                 </div>\n            </div>\n\n            {/* --- SERVICIOS Y TRANSPORTE (sin cambios en la lógica) --- */}\n             <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">Servicios Adicionales</label>\n                <div className=\"space-y-2\">\n                    <div className=\"flex items-center\">\n                        <input id=\"cepillado\" name=\"cepillado\" type=\"checkbox\" checked={servicios.cepillado} onChange={handleServicioChange} className=\"h-4 w-4 text-violet-600 focus:ring-violet-500 border-gray-300 rounded\" />\n                        <label htmlFor=\"cepillado\" className=\"ml-3 block text-sm text-gray-800\">Cepillado</label>\n                    </div>\n                    <div className=\"flex items-center\">\n                        <input id=\"rapado\" name=\"rapado\" type=\"checkbox\" checked={servicios.rapado} onChange={handleServicioChange} className=\"h-4 w-4 text-violet-600 focus:ring-violet-500 border-gray-300 rounded\" />\n                        <label htmlFor=\"rapado\" className=\"ml-3 block text-sm text-gray-800\">Rapado Parejo</label>\n                    </div>\n                    <div className=\"flex items-center\">\n                        <input id=\"corteTijera\" name=\"corteTijera\" type=\"checkbox\" checked={servicios.corteTijera} onChange={handleServicioChange} className=\"h-4 w-4 text-violet-600 focus:ring-violet-500 border-gray-300 rounded\" />\n                        <label htmlFor=\"corteTijera\" className=\"ml-3 block text-sm text-gray-800\">Corte a Tijera</label>\n                    </div>\n                </div>\n            </div>\n\n            <div>\n                <div className=\"flex items-center\">\n                    <input id=\"transporte\" name=\"transporte\" type=\"checkbox\" checked={transporte} onChange={(e) => setTransporte(e.target.checked)} className=\"h-4 w-4 text-violet-600 focus:ring-violet-500 border-gray-300 rounded\" />\n                    <label htmlFor=\"transporte\" className=\"ml-3 block text-sm font-medium text-gray-800\">¿Necesitas transporte?</label>\n                </div>\n            </div>\n\n            <button type=\"submit\" disabled={loading || !fecha || !turno || !mascota} className=\"w-full flex justify-center py-3 px-4 border border-transparent rounded-full shadow-sm text-sm font-medium text-white bg-violet-600 hover:bg-violet-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500 disabled:bg-gray-400 disabled:cursor-not-allowed\">\n                {loading ? 'Enviando Solicitud...' : 'Solicitar Turno'}\n            </button>\n        </form>\n    );\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 478, "column": 0}, "map": {"version":3,"sources":["file:///home/user/veterinariamagali/src/app/components/PrivateRoute.js"],"sourcesContent":["'use client';\n\nimport { useEffect, useState } from 'react';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { useRouter, usePathname } from 'next/navigation';\nimport { doc, getDoc } from 'firebase/firestore';\nimport { db } from '@/lib/firebase';\n\nexport default function PrivateRoute({ children }) {\n  const { user, loading } = useAuth();\n  const router = useRouter();\n  const pathname = usePathname();\n  const [isProfileComplete, setIsProfileComplete] = useState(false);\n  const [checkingProfile, setCheckingProfile] = useState(true);\n\n  useEffect(() => {\n    if (loading) return;\n\n    // If no user, redirect to login, but avoid loop if already there\n    if (!user) {\n      if (pathname !== '/login') {\n        router.push('/login');\n      }\n      // Set checking to false since we've made our decision\n      setCheckingProfile(false);\n      return;\n    }\n\n    const checkUserProfile = async () => {\n      try {\n        // Corrected collection from 'clientes' to 'users'\n        const userDocRef = doc(db, 'users', user.uid);\n        const userDoc = await getDoc(userDocRef);\n        \n        // Use the 'profileCompleted' flag for a more robust check\n        if (userDoc.exists() && userDoc.data().profileCompleted) {\n          setIsProfileComplete(true);\n        } else {\n          setIsProfileComplete(false);\n          if (pathname !== '/completar-perfil') {\n            router.push('/completar-perfil');\n          }\n        }\n      } catch (error) {\n        console.error(\"Error al verificar el perfil:\", error);\n        // On error, we'll assume profile is incomplete to be safe\n        setIsProfileComplete(false);\n        if (pathname !== '/completar-perfil') {\n          router.push('/completar-perfil');\n        }\n      } finally {\n        setCheckingProfile(false);\n      }\n    };\n\n    checkUserProfile();\n\n  }, [user, loading, router, pathname]);\n\n  // Show a loading indicator while we verify auth and profile status\n  if (loading || checkingProfile) {\n    return <div>Cargando...</div>; // Or a more sophisticated spinner/skeleton component\n  }\n\n  // If user is not logged in, and we are on a public route like /login, show the page\n  if (!user && pathname === '/login'){\n    return children;\n  }\n\n  // If the profile is complete, show the requested page\n  if (isProfileComplete) {\n    return children;\n  }\n  \n  // If the profile is not complete, but we are on the page to complete it, show the page\n  if (!isProfileComplete && pathname === '/completar-perfil') {\n    return children;\n  }\n\n  // In other cases (like waiting for redirect), return null to prevent content flash\n  return null;\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AACA;AAAA;AACA;;;AANA;;;;;;AAQe,SAAS,aAAa,KAAY;QAAZ,EAAE,QAAQ,EAAE,GAAZ;;IACnC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,GAAG,IAAA,4IAAO;IACjC,MAAM,SAAS,IAAA,kJAAS;IACxB,MAAM,WAAW,IAAA,oJAAW;IAC5B,MAAM,CAAC,mBAAmB,qBAAqB,GAAG,IAAA,yKAAQ,EAAC;IAC3D,MAAM,CAAC,iBAAiB,mBAAmB,GAAG,IAAA,yKAAQ,EAAC;IAEvD,IAAA,0KAAS;kCAAC;YACR,IAAI,SAAS;YAEb,iEAAiE;YACjE,IAAI,CAAC,MAAM;gBACT,IAAI,aAAa,UAAU;oBACzB,OAAO,IAAI,CAAC;gBACd;gBACA,sDAAsD;gBACtD,mBAAmB;gBACnB;YACF;YAEA,MAAM;2DAAmB;oBACvB,IAAI;wBACF,kDAAkD;wBAClD,MAAM,aAAa,IAAA,yKAAG,EAAC,+HAAE,EAAE,SAAS,KAAK,GAAG;wBAC5C,MAAM,UAAU,MAAM,IAAA,4KAAM,EAAC;wBAE7B,0DAA0D;wBAC1D,IAAI,QAAQ,MAAM,MAAM,QAAQ,IAAI,GAAG,gBAAgB,EAAE;4BACvD,qBAAqB;wBACvB,OAAO;4BACL,qBAAqB;4BACrB,IAAI,aAAa,qBAAqB;gCACpC,OAAO,IAAI,CAAC;4BACd;wBACF;oBACF,EAAE,OAAO,OAAO;wBACd,QAAQ,KAAK,CAAC,iCAAiC;wBAC/C,0DAA0D;wBAC1D,qBAAqB;wBACrB,IAAI,aAAa,qBAAqB;4BACpC,OAAO,IAAI,CAAC;wBACd;oBACF,SAAU;wBACR,mBAAmB;oBACrB;gBACF;;YAEA;QAEF;iCAAG;QAAC;QAAM;QAAS;QAAQ;KAAS;IAEpC,mEAAmE;IACnE,IAAI,WAAW,iBAAiB;QAC9B,qBAAO,6LAAC;sBAAI;;;;;kBAAmB,qDAAqD;IACtF;IAEA,oFAAoF;IACpF,IAAI,CAAC,QAAQ,aAAa,UAAS;QACjC,OAAO;IACT;IAEA,sDAAsD;IACtD,IAAI,mBAAmB;QACrB,OAAO;IACT;IAEA,uFAAuF;IACvF,IAAI,CAAC,qBAAqB,aAAa,qBAAqB;QAC1D,OAAO;IACT;IAEA,mFAAmF;IACnF,OAAO;AACT;GAzEwB;;QACI,4IAAO;QAClB,kJAAS;QACP,oJAAW;;;KAHN","debugId":null}}]
}